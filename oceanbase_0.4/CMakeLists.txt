# -----------------------------------------------------------------------------
# CMake build script for OceanBase.
# -----------------------------------------------------------------------------

# BUILD_LIB_TYPE  : STATIC/SHARED/BOTH, build static/shared or both, default static
# COMPILER_PATH   : Compiler root path
# COMPILER_PREFIX : Compiler prefix
# TARGET_ARCH     : ppc/ppc64/arm/x86_64/i386/ia64
# P_PROFILE       : unittest
# WITH_TEST       : ON/OFF

PROJECT(OceanBase)

CMAKE_MINIMUM_REQUIRED(VERSION 2.8.0)

ENABLE_LANGUAGE(C)

SET(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
SET(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
SET(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${PROJECT_BINARY_DIR}/bin)

IF(NOT TARGET_ARCH)
	SET(TARGET_ARCH "x86_64")
ENDIF()

# Append our module directory to CMake
SET(CMAKE_MODULE_PATH ${CMAKE_MODULE_PATH} ${CMAKE_CURRENT_SOURCE_DIR}/cmake)

INCLUDE(build_utils)

# OS
IF(CMAKE_SYSTEM MATCHES "Linux")
    INCLUDE(linux.os)
ENDIF(CMAKE_SYSTEM MATCHES "Linux")


IF(CMAKE_BUILD_TYPE STREQUAL "Debug")
    SET(CMAKE_DEBUG_POSTFIX "d" CACHE STRING "Set debug library postfix" FORCE)
ELSE()
    SET(CMAKE_DEBUG_POSTFIX "" CACHE STRING "Set debug library postfix" FORCE)
ENDIF()

ADD_CUSTOM_COMMAND(
	OUTPUT ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND echo -n 'const char* svn_version() { const char* SVN_Version = \"' > ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND echo '\"\; return SVN_Version\; }' >> ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND echo 'const char* build_date() { return __DATE__\; }' >> ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND echo 'const char* build_time() { return __TIME__\; }' >> ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND echo -n 'const char* build_flags() { return \"' >> ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND echo '\"\; }' >> ${PROJECT_SOURCE_DIR}/svn_version.cpp
	COMMAND cp ${PROJECT_SOURCE_DIR}/svn_version.cpp ${PROJECT_SOURCE_DIR}/svn_version.c
)

ADD_CUSTOM_TARGET(gen_svn_version DEPENDS ${PROJECT_SOURCE_DIR}/svn_version.cpp)

# Set COMMON FLAGS
SET(COMMON_CFLAGS "-g -D_OB_VERSION=400")
SET(COMMON_CFLAGS "${COMMON_CFLAGS} -DCOMPATIBLE -D__USE_LARGEFILE64 -D_FILE_OFFSET_BITS=64")
SET(COMMON_CFLAGS "${COMMON_CFLAGS} -D_LARGE_FILE -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE")
SET(COMMON_CFLAGS "${COMMON_CFLAGS} -DNDEBUG -finline-functions -fno-strict-aliasing -Werror")
SET(COMMON_CFLAGS "${COMMON_CFLAGS} -Wall -fPIC")

SET(COMMON_CXXFLAGS "-g -D_OB_VERSION=400")
SET(COMMON_CXXFLAGS "${COMMON_CXXFLAGS} -D_NO_EXCEPTION -finline-functions -D__STDC_LIMIT_MACROS")
SET(COMMON_CXXFLAGS "${COMMON_CXXFLAGS} -D__STDC_CONSTANT_MACROS -DNDEBUG -Wall -Werror -Wextra")
SET(COMMON_CXXFLAGS "${COMMON_CXXFLAGS} -Wunused-parameter -Wformat -fno-strict-aliasing -Wconversion")
SET(COMMON_CXXFLAGS "${COMMON_CXXFLAGS} -Wno-deprecated -D__USE_LARGEFILE64 -D_FILE_OFFSET_BITS=64")
SET(COMMON_CXXFLAGS "${COMMON_CXXFLAGS} -D_LARGE_FILE -D_LARGEFILE_SOURCE -D_LARGEFILE64_SOURCE")
SET(COMMON_CXXFLAGS "${COMMON_CXXFLAGS} -Wno-ignored-qualifiers -fPIC")

# Set COMMON DEFINES
ADD_DEFINITIONS(-DPACKAGE_NAME="OceanBase" -DPACKAGE_TARNAME="oceanbase")
ADD_DEFINITIONS(-DPACKAGE_VERSION="0.4.2.9" -DPACKAGE_STRING="OceanBase 0.4.2.9")
ADD_DEFINITIONS(-DPACKAGE_BUGREPORT="qushan@taobao.com" -DPACKAGE_URL="http://oceanbase.taobao.org/")
ADD_DEFINITIONS(-DSTDC_HEADERS=1 -DHAVE_SYS_TYPES_H=1 -DHAVE_SYS_STAT_H=1)
ADD_DEFINITIONS(-DHAVE_STDLIB_H=1 -DHAVE_STRING_H=1 -DHAVE_MEMORY_H=1)
ADD_DEFINITIONS(-DHAVE_STRINGS_H=1 -DHAVE_INTTYPES_H=1 -DHAVE_STDINT_H=1)
ADD_DEFINITIONS(-DHAVE_UNISTD_H=1 -DHAVE_DLFCN_H=1 -DPACKAGE="oceanbase")
ADD_DEFINITIONS(-DVERSION="0.4.2.9" -DRELEASEID="")

# Set local include path
INCLUDE_DIRECTORIES(
	${PROJECT_SOURCE_DIR}/src
	${PROJECT_SOURCE_DIR}/src/common
	# include libeasy header
	${PROJECT_SOURCE_DIR}/external/libeasy/include/easy
	# include libtbsys header
	${PROJECT_SOURCE_DIR}/external/tb-common-utils/include/tbsys
)

SET(JAVA_HOME_PATH "$ENV{JAVA_HOME}")
IF(x${JAVA_HOME_PATH} STREQUAL "x")
	MESSAGE(FATAL_ERROR "Set JAVA_HOME environment")
ENDIF()


IF(WITH_TEST)
	INCLUDE_DIRECTORIES(
		# include testing header
		external/testing/gtest
		external/testing/gtest/include 
		external/testing/gmock
		external/testing/gmock/include
	)
ENDIF()

ADD_SUBDIRECTORY(external)
ADD_SUBDIRECTORY(src)
ADD_SUBDIRECTORY(tools)

MESSAGE(STATUS "CMake ${CMAKE_VERSION} successfully configured ${PROJECT_NAME} using ${CMAKE_GENERATOR} generator")
MESSAGE(STATUS "")
MESSAGE(STATUS "CMAKE_C_COMPILER_ID            : ${CMAKE_C_COMPILER_ID}")
MESSAGE(STATUS "CMAKE_BUILD_TYPE               : ${CMAKE_BUILD_TYPE}")
MESSAGE(STATUS "CMAKE_C_FLAGS                  : ${CMAKE_C_FLAGS}")
MESSAGE(STATUS "CMAKE_C_FLAGS_DEBUG            : ${CMAKE_C_FLAGS_DEBUG}")
MESSAGE(STATUS "CMAKE_C_FLAGS_RELEASE          : ${CMAKE_C_FLAGS_RELEASE}")
MESSAGE(STATUS "CMAKE_C_FLAGS_RELWITHDEBINFO   : ${CMAKE_C_FLAGS_RELWITHDEBINFO}")
MESSAGE(STATUS "CMAKE_CXX_FLAGS                : ${CMAKE_CXX_FLAGS}")
MESSAGE(STATUS "CMAKE_CXX_FLAGS_DEBUG          : ${CMAKE_CXX_FLAGS_DEBUG}")
MESSAGE(STATUS "CMAKE_CXX_FLAGS_RELEASE        : ${CMAKE_CXX_FLAGS_RELEASE}")
MESSAGE(STATUS "CMAKE_CXX_FLAGS_RELWITHDEBINFO : ${CMAKE_CXX_FLAGS_RELWITHDEBINFO}")
MESSAGE(STATUS "CMAKE_SHARED_LINKER_FLAGS      : ${CMAKE_SHARED_LINKER_FLAGS}" )
MESSAGE(STATUS "CMAKE_MODULE_LINKER_FLAGS      : ${CMAKE_MODULE_LINKER_FLAGS}" )
MESSAGE(STATUS "CMAKE_EXE_LINKER_FLAGS         : ${CMAKE_EXE_LINKER_FLAGS}" )
MESSAGE(STATUS "")
MESSAGE(STATUS "TARGET_ARCH                    : ${TARGET_ARCH}")
MESSAGE(STATUS "")
MESSAGE(STATUS "CMAKE_C_COMPILER               : ${CMAKE_C_COMPILER}")
MESSAGE(STATUS "CMAKE_CXX_COMPILER             : ${CMAKE_CXX_COMPILER}")

MESSAGE(STATUS "")

